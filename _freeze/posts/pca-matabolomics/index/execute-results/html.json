{
  "hash": "38c8dfae506f6fc9aee8a8636303770a",
  "result": {
    "markdown": "---\ntitle: \"R tutorial: Principal Component Analysis with Metabolomics Data\"\ncategories: [\"R\", \"tutorial\", \"pca\", \"principal component analysis\", \"metabolomics\"]\ndate: \"2023-12-1\"\ndescription: 'An R code tutorial on how to perform principal component analysis on plant metabolomics data.'\ntoc: true\ntoc-location: left\n---\n\n\n![](/posts/pca-matabolomics/images/cover.jpg){fig-align=\"center\" width=\"800\"}\n\nIn this tutorial we will cover the steps necessary to perform a principal component analysis (*PCA*) on metebolomic data from cell cultures of a specific plant. This will help us to visualize groupings and determine possible correlations.\n\n# Packages\n\nFor this tutorial we will use a few functions inside `tidyverse`.\n\nTo install all packages in tidyverse you can run the following code:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninstall.packages(\"tidyverse\")\n```\n:::\n\n\nAnd then load them into your R session:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n:::\n\n\n# Data\n\nLet's imagine that we are interested in the effect that salt stress (due to high concentrations of NaCl) could have on plant metabolism. For this purpose, we designed an experiment with cell cultures of <a href=\"https://academic.oup.com/jxb/article/58/3/415/556150\" target=\"_blank\">*Arabidopsis thaliana*</a> species and applied different concentrations of salt in the culture medium for different times. At the end of the treatment time, we recorded the relative amount of various metabolites of interest. See the figure below for clarity:\n\n![](/posts/pca-matabolomics/images/experiment.jpg){fig-align=\"center\" width=\"800\"}  \n\nIt should be noted that salt stress is an important factor limiting plant growth and the experiment just described falls within the field of study of <a href=\"https://pubmed.ncbi.nlm.nih.gov/28196646/\" target=\"_blank\">metabolomics</a>, the study of the totality of compounds produced by the metabolism of living organisms.  \n\nFor this tutorial I took as a basis the paper: <a href=\"https://pubmed.ncbi.nlm.nih.gov/17118972/\" target=\"_blank\">Time-course metabolic profiling in Arabidopsis thaliana cell cultures after salt stress treatment</a>. I simulated the relative quantity data from the means and standard deviations reported in this article. If you are interested in how I performed such a simulation, take a look at the `data_simulation.R` and `paper_data_processing.R` files in the repository of this tutorial: <a href=\"https://github.com/juanpa-biotech/pca-metabolomics/tree/master\" target=\"_blank\">Principal Component Analysis with Metabolomics Data</a>.  \n\n# Import data\n\nData can be imported directly from the repository of this post with the following code:  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmain_data <- read_csv(\"https://raw.githubusercontent.com/juanpa-biotech/pca-metabolomics/master/data/main_data.csv\")\n```\n:::\n\n\nWe can display the first six rows of our data frame with the `head()` function:  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(main_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 6 Ã— 4\n  MET            TIME SAMPLE    QT\n  <chr>         <dbl>  <dbl> <dbl>\n1 aspartic acid   0.5      1 0.728\n2 aspartic acid   0.5      2 0.839\n3 aspartic acid   0.5      3 0.707\n4 aspartic acid   1        1 0.746\n5 aspartic acid   1        2 0.894\n6 aspartic acid   1        3 0.686\n```\n:::\n:::\n\nThe `SAMPLE` column refers to the replicates of each treatment (salt concentration per given time), in this case three.  \n\nThe names of the metabolites are as follows:  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmet_names <- as_factor(main_data$MET)\nmet_names <- levels(met_names)\nmet_names\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n [1] \"aspartic acid\"   \"asparagine\"      \"serine\"          \"glycine\"        \n [5] \"alanine\"         \"glutamic acid\"   \"glutamine\"       \"threonine\"      \n [9] \"proline\"         \"valine\"          \"tryptophan\"      \"isoleucine\"     \n[13] \"leucine\"         \"phenylalanine\"   \"pyruvate\"        \"lactate\"        \n[17] \"phosphorate\"     \"n-butylamine\"    \"ethanolamine\"    \"glycerol\"       \n[21] \"succinate\"       \"glycerate\"       \"fumarate\"        \"cadaverine\"     \n[25] \"malate\"          \"4-aminobutyrate\" \"cysteine\"        \"a-ketoglutarate\"\n[29] \"aconitate\"       \"putrescine\"      \"ribonate\"        \"shikimate\"      \n[33] \"citrate\"         \"D-fructose\"      \"glucose\"         \"lysine\"         \n[37] \"tyrosine\"        \"gluconate\"       \"galactonate\"     \"inositol\"       \n[41] \"uric acid\"       \"sucrose\"         \"trehalose\"      \n```\n:::\n:::\n\nLet us first restructure the data in a suitable form for later use in the function in charge of performing the PCA:  \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Obtain wide data \nmain_data_wd <- main_data %>% \n  mutate(SAMPLE_TIME = paste0(SAMPLE, \"-\", TIME)) %>% \n  pivot_wider(names_from = SAMPLE_TIME, values_from = QT, id_cols = -TIME:-SAMPLE)\n\n# Transposing just quantity values\nqt_data <- t(main_data_wd[, -1])\n```\n:::\n\n\nOur new data matrix has the following structure:  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nqt_data[1:10, 1:10]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n       [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]  [,8]  [,9] [,10]\n1-0.5 0.728 1.100 0.776 0.907 0.956 0.433 0.469 0.906 0.954 0.822\n2-0.5 0.839 0.978 0.789 0.908 0.960 0.476 0.459 0.998 0.948 0.816\n3-0.5 0.707 1.170 0.819 0.908 0.935 0.429 0.426 0.869 0.982 0.815\n1-1   0.746 1.000 0.828 0.857 0.829 0.559 0.628 1.010 1.020 0.982\n2-1   0.894 0.957 0.861 0.851 0.811 0.551 0.804 1.040 1.050 1.060\n3-1   0.686 0.953 0.796 0.858 0.844 0.546 0.707 1.040 1.050 0.984\n1-2   0.772 1.200 0.927 0.958 0.848 0.503 0.598 1.080 0.920 0.994\n2-2   0.762 1.290 0.829 0.970 0.790 0.498 0.593 1.050 0.939 1.170\n3-2   0.783 1.410 1.030 0.961 0.884 0.454 0.614 0.994 0.926 1.060\n1-4   1.160 1.020 0.899 0.826 0.937 0.661 0.723 0.981 0.813 1.030\n```\n:::\n:::\n\nEach row indicates an experimental unit corresponding to a given salt concentration and time, while the columns indicate the relative amounts of each metabolite.  \n\nNow let's carry out the PCA directly with the `prcomp()` function:  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nqt_pca <- prcomp(qt_data, scale. = FALSE)\n```\n:::\n\n\nWhen using this function, always remember to check the form of your data and be clear where the response variables and experimental units or replicates are marked. Usually we will be interested in reducing the number of dimensions with respect to the responses and trying to detect if there are similarities or differences between the experimental units of each treatment. With this in mind, when using `prcomp()` always make sure that the experimental units are positioned in the rows and the response variables in the columns. \n\nOn the other hand, the `scale.` argument refers to dividing each data (centered with respect to the average) by the standard deviation of the corresponding response or variable. It is recommended that this argument be set to `scale. = TRUE` when the data are not on the same measurement scale or you want to give equal importance to each variable regardless of its range or magnitude. Following what is reported in the article mentioned above, we use `scale. = FALSE`, which may be reasonable since the data are on the same relative scale.  \n\nSubsequently, let's generate a summary of the analysis with the `summary()` function:  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(qt_pca)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nImportance of components:\n                          PC1    PC2     PC3     PC4     PC5     PC6     PC7\nStandard deviation     5.3118 2.0027 0.94721 0.85199 0.54284 0.47582 0.41538\nProportion of Variance 0.8068 0.1147 0.02565 0.02076 0.00843 0.00647 0.00493\nCumulative Proportion  0.8068 0.9215 0.94712 0.96787 0.97630 0.98277 0.98771\n                           PC8     PC9    PC10    PC11    PC12    PC13    PC14\nStandard deviation     0.35457 0.24837 0.23917 0.21549 0.19492 0.19206 0.13877\nProportion of Variance 0.00359 0.00176 0.00164 0.00133 0.00109 0.00105 0.00055\nCumulative Proportion  0.99130 0.99306 0.99470 0.99603 0.99711 0.99817 0.99872\n                          PC15    PC16    PC17    PC18    PC19    PC20    PC21\nStandard deviation     0.10145 0.09904 0.08583 0.06810 0.06295 0.05556 0.05293\nProportion of Variance 0.00029 0.00028 0.00021 0.00013 0.00011 0.00009 0.00008\nCumulative Proportion  0.99901 0.99929 0.99951 0.99964 0.99975 0.99984 0.99992\n                          PC22    PC23      PC24\nStandard deviation     0.03973 0.03507 2.305e-16\nProportion of Variance 0.00005 0.00004 0.000e+00\nCumulative Proportion  0.99996 1.00000 1.000e+00\n```\n:::\n:::\n\nIn the summary above check the `Proportion of Variation` row. It can be seen that `PC1` and `PC2` explain most of the variability in the data.\n\n# Display of results\n\nBefore making some graphs to help us visualize the results of the PCA, it may be useful to establish a single theme that applies to each graph:  \n\n\n::: {.cell}\n\n```{.r .cell-code}\ntheme_set(\n  theme_classic() +\n    theme(\n      axis.text.x = element_text(color = \"black\", size = 13),\n      axis.text.y = element_text(color = \"black\", size = 13),\n      axis.title = element_text(color = \"black\", size = 15)\n    ) \n)\n```\n:::\n\n\n## Bar chart with the percentages of variation of each main component\n\nTo visualize the results of our analysis we need to extract some values from the `qt_pca` object. First let's extract the data in `qt_pca$sdev` and do some operations to represent the percentages of variation of each component:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate the variance of each principal component in PCA and store it in var_pca\nvar_pca <- qt_pca$sdev^2\n\n# Calculate the percentage of total variance explained by each principal component\nper_var_pca <- round((var_pca / sum(var_pca)) * 100, 2)\n\n# Create a tibble (data frame) to store the results, with columns PC and PER_VAR\nper_var_pca <- tibble(\n  PC = 1:length(per_var_pca),\n  PER_VAR = per_var_pca\n)\n\nper_var_pca\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 24 Ã— 2\n      PC PER_VAR\n   <int>   <dbl>\n 1     1   80.7 \n 2     2   11.5 \n 3     3    2.57\n 4     4    2.08\n 5     5    0.84\n 6     6    0.65\n 7     7    0.49\n 8     8    0.36\n 9     9    0.18\n10    10    0.16\n# â„¹ 14 more rows\n```\n:::\n:::\n\n\nLet's represent the data in per_var_pca with a bar chart:  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nbar_pca <- per_var_pca[1:6,] %>% \n  ggplot(aes(x = as.factor(PC), y = PER_VAR)) +\n  geom_col() + \n  xlab(\"PC\") +\n  ylab(\"% of total variance\")\n\nbar_pca\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/variation bar chart-1.png){width=672}\n:::\n:::\n\nAs can be seen, and as we also saw in the summary of the previous section, the first two components account for most of the variation observed in the data.  \n\n## Scatterplot with the first two principal components\n\nSince the first two components account for most of the variation, it is possible to make a two-dimensional plot that adequately represents all the data. We first extract the `qt_pca` scores and give an appropriate shape to the data frame:  \n\n\n::: {.cell}\n\n```{.r .cell-code}\npca_data <- as_tibble(qt_pca$x) %>% \n  mutate(TIME = as_factor(substr(rownames(qt_pca$x), start = 3, stop =5))) %>% \n  relocate(TIME)\n```\n:::\n\n\nSubsequently, let's make a scatter plot with the scores of the first two components:  \n\n\n::: {.cell}\n\n```{.r .cell-code}\npca_plot <- pca_data %>% \n  mutate(TIME = as_factor(TIME)) %>% \n  ggplot(aes(x = PC1, y = PC2, color = TIME)) +\n  geom_point(size = 3) +\n  xlab(paste0(\"PC1 (\", per_var_pca$PER_VAR[1], \"%)\")) +\n  ylab(paste0(\"PC2 (\", per_var_pca$PER_VAR[2], \"%)\")) +\n  scale_color_brewer(palette = \"Dark2\", name = \"Time (h)\")\n\npca_plot\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/scatter plot for pc1 and pc2-1.png){width=672}\n:::\n:::\n\nIt is interesting to note that there are several well-defined groupings and differences. In particular, the samples at time 72 h are separated from the rest with respect to PC1, while the 24 h samples are separated with respect to PC2.  \n\n## Line graph with metabolite loadings\n\nWhich metabolites contribute to the differences observed in the scatter plot above? Let us answer this question with the help of the weights or loadings.  \n\nLet us first extract the loads from `qt_pca` and also give a suitable shape to the data frame:  \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Compound names\ncompound_names <- filter(main_data, SAMPLE == 1, TIME == 0.5) %>% \n  select(MET) %>% \n  unlist()          \n\nloadigns_data <- as_tibble(qt_pca$rotation) %>% \n  signif(3) %>% \n  mutate(MET = compound_names, INDEX = 1:length(MET)) %>% \n  relocate(MET, INDEX) \n```\n:::\n\n\nLet us define a small function that replaces with a blank space the name of the metabolite if the absolute value of its charge is less than a selected threshold:  \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Function to assign compound name if absolute value of loading is bigger than set threshold\nload_tr <- function(loadings, threshold, compound_name) {\n  compound_name[!abs(loadings) > threshold] <- \" \"\n  return(compound_name)\n}\n```\n:::\n\n\nIn the following graph (PC1 loadings), using our function together with `geom_text()` shows the names of the metabolites whose load is greater than the selected threshold:  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nload_line_pc1 <- loadigns_data %>% \n  select(MET, INDEX, PC1) %>% \n  mutate(\n    MET = load_tr(loading = PC1, threshold = 0.5, compound_name = MET)\n  ) %>% \n  ggplot(aes(x = INDEX, y = PC1, label = MET)) +\n  geom_line() +\n  geom_text(fontface = \"bold\", position=position_nudge(), size = 2.5) +\n  xlab(\"Compound Index\") +\n  ylab(\"Loadings\")\n\nload_line_pc1\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/pc1 loadings-1.png){width=672}\n:::\n:::\n\nFor PC2 the loadings are displayed in the same way:  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nload_line_pc2 <- loadigns_data %>% \n  select(MET, INDEX, PC2) %>% \n  mutate(\n    MET = load_tr(loading = PC2, threshold = 0.19, compound_name = MET)\n  ) %>% \n  ggplot(aes(x = INDEX, y = PC2, label = MET)) +\n  geom_line() +\n  geom_text(\n    fontface = \"bold\", position = position_nudge(), angle = -40, size = 2.5\n    ) +\n  xlab(\"Compound Index\") +\n  ylab(\"Loadings\")\n\nload_line_pc2\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/pc2 loadings-1.png){width=672}\n:::\n:::\n\nFrom both graphs we can tentatively define the metabolites that contributed most to the similarities or differences observed in the scatter plot of PC1 and PC2: lactate, sucrose, tryptophan, phenylalanine, glycerol, inositol, lysine, uric acid, tyrosine and sucrose.  \n\nIt is important to note that the thresholds selected are similar to those of the aforementioned article. However, I believe it is important to be careful with the criteria for determining whether the loads can be considered \"large\" or \"small\". An alternative approach could be to simply take the tables with the loadings values and order them with respect to their absolute value, which would also allow us to determine the metabolites with the largest loadings.  \n\n## Patterns of metabolite variation\n\nNow that we know which compounds could be considered the most important, we can focus our attention on these metabolites and make a graph to see their pattern of behavior over time of stress treatment.  \n\nLet us first consider the most important metabolites with respect to PC1. From the original data, let us take only the lactate and sucrose data and obtain the average of the relative amounts at each treatment time. We can visualize the averages obtained with a line graph:  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmet_plot_pc1 <- main_data %>% \n  filter(MET == \"lactate\" | MET == \"sucrose\") %>% \n  group_by(MET, TIME) %>% \n  summarise(MEAN_QT = mean(QT)) %>% \n  ggplot(aes(x = TIME, y = MEAN_QT, color = MET)) +\n  geom_line(size = 1) +\n  geom_point() +\n  xlab(\"Time (h)\") +\n  ylab(\"Relative quantity\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.\nâ„¹ Please use `linewidth` instead.\n```\n:::\n\n```{.r .cell-code}\nmet_plot_pc1\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/pc1 metabolites-1.png){width=672}\n:::\n:::\n\nIt is noticeable that at 72 h the levels of these compounds increased greatly. This is probably the reason for the differences observed in the scatter plot of PC1 and PC2.  \n\nLet us repeat the same procedure for the most important metabolites with respect to PC2:  \n\n\n::: {.cell}\n\n```{.r .cell-code}\nmet_plot_pc2 <- main_data %>% \n  filter(MET == \"tryptophan\" | MET == \"phenylalanine\" | MET == \"glycerol\" |\n         MET == \"tyrosine\" | MET == \"inositol\" | MET == \"lysine\" |\n         MET == \"uric acid\") %>% \n  group_by(MET, TIME) %>% \n  summarise(MEAN_QT = mean(QT)) %>% \n  ggplot(aes(x = TIME, y = MEAN_QT, color = MET)) +\n  geom_line(size = 1) +\n  geom_point() +\n  xlab(\"Time (h)\") +\n  ylab(\"Relative quantity\")\n\nmet_plot_pc2\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/pc2 metabolites-1.png){width=672}\n:::\n:::\n\nIn this visualization we omit sucrose because we have already seen its behavior pattern. Although this graph is a little less clear, we can see that at 24 hours, the levels of metabolites such as glycerol and inositol increased, while the levels of aromatic amino acids decreased.  \n\n# Key points\n\n* In this tutorial on principal component analysis (PCA) applied to plant metabolomics data, simulated data from Arabidopsis thaliana cell cultures under salt stress were used.  \n\n* Through the implementation of the PCA with `prcomp()` and other functions included in `tidyverse` packages, clustering and correlations in the data could be observed.\n\nThe code on this post is licensed under the [Creative Commons Attribution 4.0 International License](http://creativecommons.org/licenses/by/4.0/)\n\n[![](https://img.shields.io/badge/License-CC%20BY%204.0-lightgrey.svg)](http://creativecommons.org/licenses/by/4.0/)",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}